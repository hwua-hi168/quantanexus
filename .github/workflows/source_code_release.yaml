name: Release
on:
  push:
    tags:
      - 'v*'
env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com

permissions:
  contents: write    # 创建 release & 推送到 gh-pages

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 安装 helm
      - uses: azure/setup-helm@v4
        with:
          version: latest
      - name: Get latest quantanexus-mgr and quantanexus-cs image versions from Docker Hub
        id: img
        run: |
          # 通用函数：查询 repo:latest 对应的真正 tag
          get_latest_ver() {
            local repo="$1"

            # 1. 获取 token
            local token
            token=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${repo}:pull" | jq -r .token)

            # 2. 获取 latest 的 digest(若失败则直接返回 v0.0.0)
            local digest
            digest=$(curl -s -H "Authorization: Bearer ${token}" \
                        -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
                        "https://registry-1.docker.io/v2/${repo}/manifests/latest" \
                    | jq -r '.config.digest // empty') || true

            if [[ -z "${digest}" ]]; then
              echo "v0.0.0"
              return 0
            fi

            # 3. 枚举所有 tag
            local tags
            tags=$(curl -s -H "Authorization: Bearer ${token}" \
                      "https://registry-1.docker.io/v2/${repo}/tags/list" \
                  | jq -r '.tags[] // empty') || true

            if [[ -z "${tags}" ]]; then
              echo "v0.0.0"
              return 0
            fi

            # 4. 找到与 latest 同 digest 的第一个非 latest 标签
            local tag d
            for tag in ${tags}; do
              [[ "${tag}" == "latest" ]] && continue
              d=$(curl -s -H "Authorization: Bearer ${token}" \
                    -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
                    "https://registry-1.docker.io/v2/${repo}/manifests/${tag}" \
                  | jq -r '.config.digest // empty') || true
              if [[ "${d}" == "${digest}" ]]; then
                echo "${tag}"
                return 0
              fi
            done

            # 5. 未找到匹配标签
            echo "v0.0.0"
          }

          MGR_VER=$(get_latest_ver "hwua/quantanexus-mgr")
          CS_VER=$(get_latest_ver "hwua/quantanexus-cs")

          echo "Detected mgr latest -> ${MGR_VER}, cs latest -> ${CS_VER}"
          echo "MGR_VER=$MGR_VER" >> $GITHUB_ENV
          echo "CS_VER=$CS_VER" >> $GITHUB_ENV

      # 1. 打包 Helm Chart
      - name: Package Helm Chart
        run: |
          # 如果是 tag，用 tag 名；否则用 1.0.0+sha.*****
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"   # v1.2.3 → 1.2.3
          else
            VERSION="0.0.0+sha.${GITHUB_SHA::7}"
          fi
          helm package quantanexus-mgr --version "$VERSION" --app-version "${MGR_VER}" 
          echo "QUANTANEXUS_MGR_TGZ=quantanexus-mgr-${VERSION}.tgz" >> $GITHUB_ENV
          helm package quantanexus-cs --version "$VERSION" --app-version "${MGR_VER}" #都用mgr的version
          echo "QUANTANEXUS_CS_TGZ=quantanexus-cs-${VERSION}.tgz" >> $GITHUB_ENV

      # 2. 更新 Helm Repo（gh-pages）
      - name: Update index.yaml
        run: |
          git clone --depth 1 --branch gh-pages \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages
          mv *.tgz gh-pages/
          cd gh-pages
          helm repo index . --merge index.yaml \
            --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          git add .
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -m "Add chart ${{ github.ref_name }}"
          git push
          
      # 3. 构建产物（源码包 + 校验文件）并上传到 d.hi168.com/qn
      - name: Build artifacts and Upload to d.hi168.com/qn
        run: |
          mkdir -p /tmp/artifacts
          VERSION="${GITHUB_REF_NAME}"    
          ZIP_FILE="quantanexus-${GITHUB_REF_NAME}.zip"
          TAR_GZ_FILE="quantanexus-${GITHUB_REF_NAME}.tar.gz"
          
          # 3.1. 构建产物
          echo "--- 3.1. 构建产物 ---"
          sed  "s/{{ QNI_VER }}/$VERSION/" install/kubeasz/ezdown.in > /tmp/artifacts/ezdown
          # 构建源码包（zip 和 tar.gz）
          zip -r /tmp/artifacts/$ZIP_FILE . \
            -x '.git/*' -x '*.zip' -x '.github/*' -x '*.gz' \
            -x 'quantanexus-*.zip' -x 'quantanexus-*.tar.gz'
          tar --exclude='.git' --exclude='*.zip' --exclude='.github' --exclude='*.gz' \
            -czf /tmp/artifacts/$TAR_GZ_FILE .
            
          # 移动到当前目录，供后续步骤使用
          mv /tmp/artifacts/* .              
          
          # 生成校验文件
          sha256sum *.zip *.tar.gz ezdown > quantanexus-checksums.txt  
          
          # 3.2. 上传源码包 (.tar.gz) 到 d.hi168.com/qn
          echo "--- 3.2. 上传源码包到 d.hi168.com/qn ---"
          LOCAL_FILE="$TAR_GZ_FILE"
          SERVER="https://d.hi168.com/filebrowser"
          USERNAME="${{ secrets.DOWNLOAD_CENTER_USERNAME }}"
          PASSWORD="${{ secrets.DOWNLOAD_CENTER_PASSWORD }}"
          REMOTE_PATH="qn" # 目标路径设置为 qn
          
          echo "准备上传文件 $LOCAL_FILE 到 $SERVER/$REMOTE_PATH/"
          
          # 1. 登录获取 Token
          echo "正在登录..."
          API_TOKEN=$(curl -s -X POST \
            $SERVER/api/login \
            -H 'Content-Type: application/json' \
            -d "{\"username\":\"$USERNAME\",\"password\":\"$PASSWORD\"}" )
          
          if [ -z "$API_TOKEN" ]; then
              echo "错误：登录失败，请检查用户名和密码"
              exit 1
          fi
          echo "API_TOKEN: (Hidden)"
          
          # 2. 上传文件
          # 目标 API 路径应为 $SERVER/api/resources/$REMOTE_PATH/$LOCAL_FILE
          TARGET_URL="$SERVER/api/resources/${REMOTE_PATH}/${LOCAL_FILE}?override=true"
          echo "正在上传文件 $LOCAL_FILE 到 $TARGET_URL ..."
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$TARGET_URL" \
            -H "X-Auth: $API_TOKEN" \
            --data-binary "@$LOCAL_FILE")
          
          # 分离响应体和状态码
          HTTP_STATUS=$(echo "$UPLOAD_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | head -n -1)
          
          echo "HTTP状态码: $HTTP_STATUS"
          echo "服务器响应: $RESPONSE_BODY"
          
          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then # 200/201 均视为成功
              echo "上传成功！文件可在 d.hi168.com/$REMOTE_PATH/$LOCAL_FILE 访问。"
          else
              echo "上传失败！"
              exit 1
          fi

      # 4. 创建 GitHub Release 并上传资产
      - name: Create Release & Upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Quantanexus Helm Chart ${{ github.ref_name }}
            - Chart: quantanexus-${{ github.ref_name }}.tgz
            - Full source archives attached below.
          files: |
            *.zip
            *.tar.gz
            quantanexus-checksums.txt
            quantanexus-${{ github.ref_name }}.tgz
            ezdown
          draft: false
          prerelease: false