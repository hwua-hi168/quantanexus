name: Release
on:
  push:
    tags:
      - 'v*'
env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com

permissions:
  contents: write    # 创建 release & 推送到 gh-pages

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 安装 helm
      - uses: azure/setup-helm@v4
        with:
          version: latest

      # 1. 打包 Helm Chart
      - name: Package Helm Chart
        run: |
          # 如果是 tag，用 tag 名；否则用 1.0.0+sha.*****
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"   # v1.2.3 → 1.2.3
          else
            VERSION="0.0.0+sha.${GITHUB_SHA::7}"
          fi
          helm package quantanexus-mgr --version "$VERSION" --app-version "$VERSION"
          echo "QUANTANEXUS_MGR_TGZ=quantanexus-mgr-${VERSION}.tgz" >> $GITHUB_ENV
          helm package quantanexus-cs --version "$VERSION" --app-version "$VERSION"
          echo "QUANTANEXUS_CS_TGZ=quantanexus-cs-${VERSION}.tgz" >> $GITHUB_ENV

      # 2. 更新 Helm Repo（gh-pages）
      - name: Update index.yaml
        run: |
          git clone --depth 1 --branch gh-pages \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages
          mv *.tgz gh-pages/
          cd gh-pages
          helm repo index . --merge index.yaml \
            --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          git add .
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -m "Add chart ${{ github.ref_name }}"
          git push

      # 3. 构建产物（源码包 + 校验文件）
      - name: Build artifacts
        run: |
          mkdir -p /tmp/artifacts
          zip -r /tmp/artifacts/quantanexus-${GITHUB_REF_NAME}.zip . \
            -x '.git/*' -x '*.zip' -x '.github/*' -x '*.gz' \
            -x 'quantanexus-*.zip' -x 'quantanexus-*.tar.gz'
          tar --exclude='.git' --exclude='*.zip' --exclude='.github' --exclude='*.gz' \
            -czf /tmp/artifacts/quantanexus-${GITHUB_REF_NAME}.tar.gz .
          mv /tmp/artifacts/* .                       
          sha256sum *.zip *.tar.gz > quantanexus-checksums.txt  

      # 4. 创建 GitHub Release 并上传资产
      - name: Create Release & Upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Quantanexus Helm Chart ${{ github.ref_name }}
            - Chart: quantanexus-${{ github.ref_name }}.tgz
            - Full source archives attached below.
          files: |
            *.zip
            *.tar.gz
            quantanexus-checksums.txt
            quantanexus-${{ github.ref_name }}.tgz
          draft: false
          prerelease: false