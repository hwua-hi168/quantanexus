name: Release
on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com

permissions:
  contents: write    # 创建 release & 推送到 gh-pages

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 安装 helm
      - uses: azure/setup-helm@v4
        with:
          version: latest

      # 1. 打包 Helm Chart
      - name: Package Helm Chart
        run: |
          pwd && ls -la \
          helm package quantanexus-mgr \
            --version ${{ github.ref_name }} \
            --app-version ${{ github.ref_name }}
          echo "QUANTANEXUS_MGR_TGZ=quantanexus-mgr-${{ github.ref_name }}.tgz" >> $GITHUB_ENV
          helm package quantanexus-cs \
            --version ${{ github.ref_name }} \
            --app-version ${{ github.ref_name }}
            echo "QUANTANEXUS_CS_TGZ=quantanexus-cs-${{ github.ref_name }}.tgz" >> $GITHUB_ENV

      # 2. 更新 Helm Repo（gh-pages）
      - name: Update index.yaml
        run: |
          git clone --depth 1 --branch gh-pages \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git gh-pages
          mv *.tgz gh-pages/
          cd gh-pages
          helm repo index . --merge index.yaml \
            --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          git add .
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -m "Add chart ${{ github.ref_name }}"
          git push

      # 3. 构建产物（源码包 + 校验文件）
      - name: Build artifacts
        run: |
          zip -r quantanexus-${GITHUB_REF_NAME}.zip . \
            -x '.git/*' -x '*.zip' -x '.github/*' -x '*.gz'
          tar --exclude='.git' --exclude='*.zip' --exclude='.github' --exclude='*.gz' \
            -czf quantanexus-${GITHUB_REF_NAME}.tar.gz .
          sha256sum *.zip *.tar.gz *.tgz > quantanexus-checksums.txt

      # 4. 创建 GitHub Release 并上传资产
      - name: Create Release & Upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Quantanexus Helm Chart ${{ github.ref_name }}
            - Chart: quantanexus-${{ github.ref_name }}.tgz
            - Full source archives attached below.
          files: |
            *.zip
            *.tar.gz
            quantanexus-checksums.txt
            quantanexus-${{ github.ref_name }}.tgz
          draft: false
          prerelease: false