# .github/workflows/update-charts-mirror.yml
name: Update Helm Charts Mirror

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
    # paths:
    #   - 'tools/charts-mirror/**'
    #   - 'quantanexus-cs/**'
    #   - 'quantanexus-mgr/**'
      
jobs:
  update-charts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # å®‰è£… helm
    - uses: azure/setup-helm@v4
      with:
        version: latest
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        
    - name: Step 1 - Update and Package Charts
      env:
        DOWNLOAD_CENTER_PASSWORD: ${{ secrets.DOWNLOAD_CENTER_PASSWORD }}
      run: |
        echo "=== Step 1: Updating Helm Charts ==="
        
        # é…ç½®å˜é‡
        CHART_DESTINATION="tools/charts-mirror/charts"
        CHART_FILE="tools/charts-mirror/charts.csv"
        MIRRORS_ARCHIVE="tools/charts-mirror/mirrors.tar.gz"
        DOWNLOAD_URL="https://d.hi168.com/qn/mirrors.tar.gz"
        
        # 1. æ£€æŸ¥ CSV æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$CHART_FILE" ]; then
            echo "Error: Chart list file '$CHART_FILE' not found." >&2
            exit 1
        fi
        
        # ç¡®ä¿ charts ç›®å½•å­˜åœ¨
        mkdir -p "$CHART_DESTINATION"
        
        # ä¸‹è½½æ—§çš„ charts åŒ…
        echo "=== Downloading existing charts archive ==="
        if wget -O "$MIRRORS_ARCHIVE" "$DOWNLOAD_URL"; then
            echo "Successfully downloaded existing charts archive"
            echo "Extracting charts from archive..."
            # åˆ›å»ºä¸´æ—¶ç›®å½•è§£å‹ï¼Œç„¶ååªç§»åŠ¨ charts å†…å®¹
            mkdir -p temp_extract
            tar -xzf "$MIRRORS_ARCHIVE" -C temp_extract
            # æ£€æŸ¥è§£å‹åçš„ç›®å½•ç»“æ„ï¼Œæ‰¾åˆ° charts ç›®å½•å¹¶ç§»åŠ¨å†…å®¹
            if [ -d "temp_extract/tools/charts-mirror/charts" ]; then
                mv temp_extract/tools/charts-mirror/charts/* "$CHART_DESTINATION"/ 2>/dev/null || true
            elif [ -d "temp_extract/charts" ]; then
                mv temp_extract/charts/* "$CHART_DESTINATION"/ 2>/dev/null || true
            fi
            rm -rf temp_extract
            echo "Extracted existing charts to $CHART_DESTINATION/"
        else
            echo "Warning: Could not download existing charts archive, starting fresh"
        fi
        
        # æ‰“åŒ… quantanexus-cs
        if [ -d "quantanexus-cs" ]; then
            echo "-> Packaging quantanexus-cs..."
            cd quantanexus-cs
            helm package .
            PACKAGED_FILE=$(ls *.tgz | head -1)
            if [ -n "$PACKAGED_FILE" ]; then
                mv "$PACKAGED_FILE" "../$CHART_DESTINATION/"
                echo "   Moved $PACKAGED_FILE to charts directory"
            fi
            cd ..
        else
            echo "Warning: quantanexus-cs directory not found"
        fi
        
        # æ‰“åŒ… quantanexus-mgr
        if [ -d "quantanexus-mgr" ]; then
            echo "-> Packaging quantanexus-mgr..."
            cd quantanexus-mgr
            helm dependency update
            helm package .
            PACKAGED_FILE=$(ls *.tgz | head -1)
            if [ -n "$PACKAGED_FILE" ]; then
                mv "$PACKAGED_FILE" "../$CHART_DESTINATION/"
                echo "   Moved $PACKAGED_FILE to charts directory"
            fi
            cd ..
        else
            echo "Warning: quantanexus-mgr directory not found"
        fi
        
        # ä» CSV æ–‡ä»¶ä¸‹è½½ä¾èµ–çš„ charts
        echo "=== Downloading Dependency Charts from $CHART_FILE ==="
        
        while IFS=, read -r NAME VERSION REPO
        do
            # è·³è¿‡ä»¥ '#' å¼€å¤´çš„æ³¨é‡Šè¡Œ
            [[ "$NAME" =~ ^#.* ]] && continue
            
            # ç§»é™¤è¡Œé¦–å°¾çš„ç©ºæ ¼
            NAME=$(echo "$NAME" | xargs)
            VERSION=$(echo "$VERSION" | xargs)
            REPO=$(echo "$REPO" | xargs)
            
            if [ -z "$NAME" ] || [ -z "$VERSION" ] || [ -z "$REPO" ]; then
                continue
            fi
            
            echo "-> Pulling chart: $NAME (Version: $VERSION) from $REPO"
            helm pull "$NAME" --version "$VERSION" --repo "$REPO" --destination "$CHART_DESTINATION"/
        done < "$CHART_FILE"
        
        # ç”Ÿæˆæ–°çš„ç´¢å¼•
        echo "Generating new repository index..."
        helm repo index "$CHART_DESTINATION"/ --url https://helm.hi168.com/charts/
        
        # æ‰“åŒ… charts ç›®å½• - ä¿®æ”¹è¿™é‡Œï¼Œåªæ‰“åŒ… charts ç›®å½•å†…å®¹
        echo "=== Packaging charts directory ==="
        # è¿›å…¥ charts ç›®å½•çš„çˆ¶ç›®å½•
        cd "$(dirname "$CHART_DESTINATION")"
        # åªæ‰“åŒ… charts ç›®å½•ï¼Œä¸åŒ…å«å®Œæ•´è·¯å¾„
        tar -zcvf "$(basename "$MIRRORS_ARCHIVE")" "$(basename "$CHART_DESTINATION")"/
        # å›åˆ°åŸç›®å½•
        cd -
        echo "Created archive: $MIRRORS_ARCHIVE"
        
        # æ˜¾ç¤ºç”Ÿæˆçš„ charts
        echo "Generated charts:"
        ls -la "$CHART_DESTINATION"/
        
        echo "=== Step 1 Complete: Charts updated and packaged ==="
        
    - name: Upload charts artifact
      uses: actions/upload-artifact@v4
      with:
        name: charts-mirror
        path: |
          tools/charts-mirror/charts/
          tools/charts-mirror/mirrors.tar.gz
        retention-days: 1

  build-docker:
    runs-on: ubuntu-latest
    needs: update-charts
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download charts artifact
      uses: actions/download-artifact@v4
      with:
        name: charts-mirror
        path: tools/charts-mirror/
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Aliyun Container Registry
      uses: docker/login-action@v3
      with:
        registry: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_REGISTRY_USER }}
        password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        
    - name: Step 2 - Build and Push Docker Image
      run: |
        echo "=== Step 2: Building and Pushing Docker Image ==="
        
        # ç¡®å®šé•œåƒæ ‡ç­¾
        if [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
          TAG="${{ github.ref_name }}"
        else
          TAG="${{ github.sha }}"
        fi
        
        REPO_NAME="quantanexus/helm"
        REGISTRY="registry.cn-hangzhou.aliyuncs.com"
        
        echo "Building Docker image with tag: $TAG"
        
        # æ„å»ºé•œåƒ
        cd tools/charts-mirror/
        docker build -t "$REGISTRY/$REPO_NAME:$TAG" .
        
        # æ¨é€é•œåƒ
        echo "Pushing Docker image..."
        docker push "$REGISTRY/$REPO_NAME:$TAG"
        
        # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼ŒåŒæ—¶æ ‡è®°ä¸ºlatest
        if [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
          echo "Also tagging as latest..."
          docker tag "$REGISTRY/$REPO_NAME:$TAG" "$REGISTRY/$REPO_NAME:latest"
          docker push "$REGISTRY/$REPO_NAME:latest"
        fi
        
        echo "=== Step 2 Complete: Docker image built and pushed ==="

  upload-archive:
    runs-on: ubuntu-latest
    needs: [update-charts, build-docker]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download charts artifact
      uses: actions/download-artifact@v4
      with:
        name: charts-mirror
        path: tools/charts-mirror/
        
    - name: Step 3 - Upload Archive to Server
      env:
        DOWNLOAD_CENTER_PASSWORD: ${{ secrets.DOWNLOAD_CENTER_PASSWORD }}
        DOWNLOAD_CENTER_USERNAME: ${{ secrets.DOWNLOAD_CENTER_USERNAME }}
      run: |
        cd tools/charts-mirror/
        
        echo "=== Step 3: Uploading Archive to Server ==="
        
        SERVER="https://d.hi168.com/filebrowser"
        USERNAME="$DOWNLOAD_CENTER_USERNAME"
        LOCAL_FILE="mirrors.tar.gz"
        
        # æ£€æŸ¥å¯†ç ç¯å¢ƒå˜é‡
        if [ -z "$DOWNLOAD_CENTER_PASSWORD" ]; then
            echo "Error: DOWNLOAD_CENTER_PASSWORD environment variable is not set" >&2
            exit 1
        fi
        
        # 1. ç™»å½•è·å– Token
        echo "æ­£åœ¨ç™»å½•..."
        API_TOKEN=$(curl -s -X POST \
          $SERVER/api/login \
          -H 'Content-Type: application/json' \
          -d "{\"username\":\"$DOWNLOAD_CENTER_USERNAME\",\"password\":\"$DOWNLOAD_CENTER_PASSWORD\"}" )

        if [ -z "$API_TOKEN" ]; then
            echo "é”™è¯¯ï¼šç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "
            exit 1
        fi
        echo "Login successful"
        
        # 2. ä¸Šä¼ æ–‡ä»¶ - ä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼
        echo "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶ $LOCAL_FILE åˆ° $SERVER ..."
        
        # é¦–å…ˆæ£€æŸ¥æœ¬åœ°æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
        if [ ! -f "$LOCAL_FILE" ]; then
            echo "é”™è¯¯ï¼šæœ¬åœ°æ–‡ä»¶ $LOCAL_FILE ä¸å­˜åœ¨"
            exit 1
        fi
        
        # éªŒè¯æœ¬åœ°æ–‡ä»¶æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ tar.gz æ–‡ä»¶
        if ! tar -tzf "$LOCAL_FILE" > /dev/null 2>&1; then
            echo "é”™è¯¯ï¼šæœ¬åœ°æ–‡ä»¶ $LOCAL_FILE ä¸æ˜¯æœ‰æ•ˆçš„ tar.gz æ–‡ä»¶"
            exit 1
        fi
        
        echo "æœ¬åœ°æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œå¼€å§‹ä¸Šä¼ ..."
        
        # ä½¿ç”¨æ›´ç®€æ´çš„ä¸Šä¼ æ–¹å¼
        UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "$SERVER/api/resources/qn/$LOCAL_FILE?override=true" \
          -H "X-Auth: $API_TOKEN" \
          -H "Content-Type: application/octet-stream" \
          --data-binary "@$LOCAL_FILE")
        
        # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
        HTTP_STATUS=$(echo "$UPLOAD_RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | head -n -1)
        
        echo "HTTPçŠ¶æ€ç : $HTTP_STATUS"
        echo "æœåŠ¡å™¨å“åº”: $RESPONSE_BODY"
        
        if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "ä¸Šä¼ æˆåŠŸï¼"
        else
            echo "ä¸Šä¼ å¤±è´¥ï¼"
            echo "å°è¯•ä½¿ç”¨å¤‡ç”¨ä¸Šä¼ æ–¹æ³•..."
            
            # å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨ multipart form ä½†æ›´ç®€æ´çš„æ–¹å¼
            UPLOAD_RESPONSE2=$(curl -s -w "\n%{http_code}" -X POST \
              "$SERVER/api/upload/qn/?override=true" \
              -H "X-Auth: $API_TOKEN" \
              -F "file=@$LOCAL_FILE")
            
            HTTP_STATUS2=$(echo "$UPLOAD_RESPONSE2" | tail -n1)
            RESPONSE_BODY2=$(echo "$UPLOAD_RESPONSE2" | head -n -1)
            
            echo "å¤‡ç”¨æ–¹æ³• HTTPçŠ¶æ€ç : $HTTP_STATUS2"
            echo "å¤‡ç”¨æ–¹æ³•æœåŠ¡å™¨å“åº”: $RESPONSE_BODY2"
            
            if [ "$HTTP_STATUS2" -ne 200 ]; then
                exit 1
            fi
        fi
        
        echo "=== Step 3 Complete: Archive uploaded to server ==="
        
    - name: Verify upload
      run: |
        # éªŒè¯æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ 
        echo "Verifying upload by checking if mirrors.tar.gz exists..."
        
        # å°è¯•ä¸‹è½½åˆšåˆšä¸Šä¼ çš„æ–‡ä»¶æ¥éªŒè¯
        if wget -q --spider "https://d.hi168.com/qn/mirrors.tar.gz"; then
          echo "âœ… mirrors.tar.gz is accessible"
        else
          echo "âŒ mirrors.tar.gz might not be accessible"
          exit 1
        fi

  summary:
    runs-on: ubuntu-latest
    needs: [update-charts, build-docker, upload-archive]
    
    steps:
    - name: Workflow Summary
      run: |
        echo "ğŸ‰ Helm Charts Mirror Update Complete!"
        echo ""
        echo "ğŸ“Š Summary:"
        echo "  âœ… Charts updated and packaged"
        echo "  âœ… Docker image built and pushed"
        echo "  âœ… Archive uploaded to server"
        echo ""
        echo "ğŸŒ Access your updated charts at:"
        echo "   https://d.hi168.com/qn/mirrors.tar.gz"
        echo "   https://helm.hi168.com/charts/"