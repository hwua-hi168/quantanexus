# In main.yml

# ==================== Step 1: Deploy Tigera Operator ====================
- name: Deploy Tigera Operator (from template)
  k8s:
    definition: "{{ lookup('template', 'templates/calico-tigera-operator-v3.31.2.yaml.j2') }}"
    state: present
  delegate_to: localhost
  run_once: true

- name: Wait for tigera-operator pod to be ready
  k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ calico_operator_namespace }}"
    label_selectors:
      - k8s-app=tigera-operator
  register: operator_pod
  until: >
    operator_pod.resources | length == 1 and
    operator_pod.resources[0].status.phase == 'Running' and
    operator_pod.resources[0].status.containerStatuses is defined and
    operator_pod.resources[0].status.containerStatuses[0].ready == true
  retries: 30
  delay: 5
  delegate_to: localhost
  run_once: true

# --- 新增任务：等待 Installation CRD 建立 ---
- name: Wait for Installation CRD to be established
  k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: installations.operator.tigera.io
  register: crd_status
  until: >
    crd_status.resources | length == 1 and
    crd_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Established') | map(attribute='status') | first == 'True'
  retries: 30
  delay: 5
  delegate_to: localhost
  run_once: true
# ---------------------------------------------

# ==================== Step 2: Deploy Calico CRs ====================
- name: Deploy Calico Enterprise Configuration (Installation, APIServer, etc.)
  k8s:
    definition: "{{ lookup('template', 'templates/customer-resource.yaml.j2') }}"
    state: present
  when: calico_enterprise_enabled | bool
  delegate_to: localhost
  run_once: true

- name: Wait for Installation to be ready
  k8s_info:
    api_version: operator.tigera.io/v1
    kind: Installation
    name: default
  register: install_status
  until: >
    install_status.resources | length == 1 and
    install_status.resources[0] is defined and
    install_status.resources[0].status is defined and
    install_status.resources[0].status.conditions is defined and
    install_status.resources[0].status.conditions | 
    selectattr('type', 'equalto', 'Ready') | 
    list | length > 0 and
    (install_status.resources[0].status.conditions | 
     selectattr('type', 'equalto', 'Ready') | 
     map(attribute='status') | 
     first) == 'True'
  retries: 40
  delay: 10
  delegate_to: localhost
  run_once: true