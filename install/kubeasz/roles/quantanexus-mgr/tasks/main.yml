- name: 添加 Quantanexus Helm 仓库
  kubernetes.core.helm_repository:
    name: hi168
    repo_url: https://helm.hi168.com/charts
    state: present

- name: 更新 Helm 仓库
  shell: helm repo update
  args:
    executable: /bin/bash

- name: 检查 quantanexus-mgr chart 是否可用
  shell: |
    helm search repo hi168/quantanexus-mgr --version "{{ quantanexus_version }}" -o json
  args:
    executable: /bin/bash
  register: chart_search
  changed_when: false

- name: 显示 chart 信息
  debug:
    msg: "Chart 信息: {{ chart_search.stdout }}"

- name: 创建 values.yaml 配置文件
  template:
    src: values.yaml.j2
    dest: "/tmp/quantanexus-mgr-values.yaml"

- name: 创建 quantanexus-mgr 命名空间
  kubernetes.core.k8s:
    name: "{{ quantanexus_mgr_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: 部署 Quantanexus-Mgr
  kubernetes.core.helm:
    name: quantanexus-mgr
    chart_ref: hi168/quantanexus-mgr
    release_namespace: "{{ quantanexus_mgr_namespace }}"
    chart_version: "{{ quantanexus_version }}"
    values_files:
      - "/tmp/quantanexus-mgr-values.yaml"
    state: present
    wait: true
    wait_timeout: "300s"