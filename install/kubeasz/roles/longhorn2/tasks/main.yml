---
- name: 添加 Longhorn Helm 仓库
  kubernetes.core.helm_repository:
    name: hi168
    repo_url: https://helm.hi168.com/charts
    state: present

- name: 创建 longhorn 命名空间
  kubernetes.core.k8s:
    name: "{{ longhorn_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: 渲染 values.yaml
  template:
    src: values.yaml.j2
    dest: "/tmp/longhorn-values.yaml"
    mode: '0644'

- name: 部署Longhorn
  kubernetes.core.helm:
    name: longhorn
    chart_ref: hi168/longhorn
    release_namespace: "{{ longhorn_namespace }}"
    chart_version: "{{ longhorn_version }}"
    values_files:
      - "/tmp/longhorn-values.yaml"
    state: present
    wait: true          # Helm 原生等待
    wait_timeout: "5m" # 带单位字符

- name: 等待 Longhorn Pods 就绪（原生模块）
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ longhorn_namespace }}"
    label_selectors:
      - app.kubernetes.io/instance=longhorn
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "300"