---
- name: 创建 minio 命名空间
  kubernetes.core.k8s:
    name: "{{ minio_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: 查询 minio 是否已部署
  kubernetes.core.helm_info:
    name: "{{ minio_release | default('minio') }}"
    release_namespace: "{{ minio_namespace }}"
  register: minio_helm_info

- name: Add/Update MinIO Helm repository
  kubernetes.core.helm_repository:
    name: minio
    repo_url: "{{ minio_chart_repo | default('https://charts.min.io/') }}"
  when: minio_helm_info.status is undefined

- name: 渲染 MinIO values 文件
  ansible.builtin.template:
    src: values.yaml.j2
    dest: /tmp/minio-values-{{ minio_release | default('minio') }}.yaml
    mode: '0600'
  when: minio_helm_info.status is undefined

- name: 安装/升级 MinIO 分布式集群
  kubernetes.core.helm:
    name: "{{ minio_release | default('minio') }}"
    chart_ref: "{{ minio_chart_name | default('minio/minio') }}"
    chart_version: "{{ minio_chart_version | default(omit) }}"
    release_namespace: "{{ minio_namespace | default('default') }}"
    create_namespace: true
    values_files:
      - /tmp/minio-values-{{ minio_release | default('minio') }}.yaml
    wait: true
    timeout: "3m"
  when: minio_helm_info.status is undefined

- name: 等待所有 MinIO Pod 就绪
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ minio_namespace | default('default') }}"
    label_selectors:
      - app=minio
  register: minio_pods
  until: >
    minio_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length ==
    minio_pods.resources | length
  retries: 60
  delay: 10
  when: minio_helm_info.status is undefined



# 1. 获取 MinIO NodePort（控制台 9001）
- name: 获取 MinIO 控制台 NodePort
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: minio
    namespace: "{{ minio_namespace }}"
  register: minio_svc
  when: minio_helm_info.status is undefined

- name: 获取 MinIO root 凭据（来自 Secret）
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: minio
    namespace: "{{ minio_namespace }}"
  register: minio_secret
  when: minio_helm_info.status is undefined      # 仅第一次安装后才执行

- name: 解析 root 账号
  set_fact:
    minio_root_user: "{{ minio_secret.resources[0].data.rootUser | b64decode }}"
    minio_root_password: "{{ minio_secret.resources[0].data.rootPassword | b64decode }}"
  when: minio_helm_info.status is undefined      # 仅第一次安装后才执行

- name: 打印 JuiceFS 桶访问信息（ClusterIP）
  ansible.builtin.debug:
    msg:
      - "minio_root_user : {{ minio_root_user }}"
      - "minio_root_password    : {{ minio_root_password }}"
  when: minio_helm_info.status is undefined      # 仅第一次安装后才执行

- name: 用 mc 创建 juicefs-s3-public 桶（真实凭据）
  kubernetes.core.k8s_exec:
    namespace: "{{ minio_namespace }}"
    pod: "{{ minio_pods.resources[0].metadata.name }}"
    command: |
      /bin/sh -c "
      until curl -f http://localhost:9000/minio/health/live; do sleep 2; done;
      mc alias set local http://localhost:9000 {{ minio_root_user }} {{ minio_root_password }};
      mc mb --ignore-existing local/{{ minio_juicefs_bucket_name | default('juicefs-s3-public') }};
      mc anonymous set {{ minio_juicefs_bucket_policy | default('download') }} local/{{ minio_juicefs_bucket_name | default('juicefs-s3-public') }} || true
      "
  register: mc_result
  failed_when: >
    "created successfully" not in mc_result.stdout | lower and
    "already exists" not in mc_result.stdout | lower
  when: minio_helm_info.status is undefined

- name: 检查桶是否存在（
  kubernetes.core.k8s_exec:
    namespace: "{{ minio_namespace }}"
    pod: "{{ minio_pods.resources[0].metadata.name }}"
    command: |
      /bin/sh -c "
      mc alias set local http://localhost:9000 {{ minio_root_user }} {{ minio_root_password }};
      mc ls local/ | grep -q '{{ minio_juicefs_bucket_name | default('juicefs-s3-public') }}' && echo 'EXISTS' || echo 'NOT_FOUND'
      "
  register: bucket_check
  failed_when: false
  when: minio_helm_info.status is undefined

- name: 设置 JuiceFS 桶访问信息（ClusterIP 域名）
  set_fact:
    juicefs_s3_bucket: "http://minio.{{ minio_namespace }}.svc.cluster.local:9000/{{ minio_juicefs_bucket_name | default('juicefs-s3-public') }}"
    juicefs_s3_access_key: "{{ minio_root_user }}"
    juicefs_s3_secret_key: "{{ minio_root_password }}"
  when: minio_helm_info.status is undefined

- name: 打印 JuiceFS 桶访问信息（ClusterIP）
  ansible.builtin.debug:
    msg:
      - "JuiceFS S3 地址 : {{ juicefs_s3_bucket }}"
      - "Access Key     : {{ juicefs_s3_access_key }}"
      - "Secret Key     : {{ juicefs_s3_secret_key }}"
  when: minio_helm_info.status is undefined
