---
- name: 添加 Prometheus Helm 仓库
  kubernetes.core.helm_repository:
    name: hi168
    repo_url: https://helm.hi168.com/charts
    state: present

- name: 渲染 values.yaml
  template:
    src: values.yaml.j2
    dest: "/tmp/prometheus-values.yaml"
    mode: '0600'
- name: 创建 prom 命名空间
  kubernetes.core.k8s:
    name: prom
    api_version: v1
    kind: Namespace
    state: present

- name: 查询是否已安装 prometheus
  kubernetes.core.helm_info:
    name: prometheus
    release_namespace: prom
  register: prom_status

- name: 部署Prometheus
  kubernetes.core.helm:
    name: prometheus
    chart_ref: hi168/kube-prometheus-stack
    release_namespace: prom
    chart_version: "{{ prometheus_version }}"
    values_files:
      - "/tmp/prometheus-values.yaml"
    state: present
    wait: true
    wait_timeout: 300
  when: >
    prom_status.status is not defined or
    prom_status.status.status != "deployed"