- name: echo hello common
  shell: "echo hello common"

- name: 尝试加载fuse module 
  shell: 'modprobe fuse || echo "NoFound"'
  register: FUSE  

- name: 加载内核模块
  modprobe: name={{ item }} state=present
  with_items:
    - dm_crypt
  ignore_errors: true

- name: 追加 fuse 到开机模块加载配置
  lineinfile:
    path: /etc/modules-load.d/10-k8s-modules.conf
    line: 'fuse'
    create: yes
    state: present
    mode: '0644'

- name: 追加 dm_crypt 到开机模块加载配置
  lineinfile:
    path: /etc/modules-load.d/10-k8s-modules.conf
    line: 'dm_crypt'
    create: yes
    state: present
    mode: '0644'    

- name: 停止 multipathd 服务
  systemd:
    name: multipathd
    state: stopped
    enabled: no
  failed_when: false

- name: 卸载 dm_multipath 内核模块
  modprobe:
    name: dm_multipath
    state: absent
  failed_when: false