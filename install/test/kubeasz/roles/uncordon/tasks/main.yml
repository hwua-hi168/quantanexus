---
- name: 获取所有节点信息
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: nodes_info

- name: 显示当前节点名称列表
  debug:
    msg: "{{ nodes_info.resources | map(attribute='metadata.name') | list }}"

- name: 获取节点详细状态（宽格式）
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: nodes_detailed

- name: 显示节点详细状态
  debug:
    msg: |
      {% for node in nodes_detailed.resources %}
      {{ "%-20s %-10s %-10s %-20s %-10s %-10s" | format(
           node.metadata.name,
           node.status.conditions | selectattr('type', 'equalto', 'Ready') | map(attribute='status') | first,
           node.status.nodeInfo.kubeletVersion,
           (node.status.addresses | selectattr('type', 'equalto', 'InternalIP') | map(attribute='address') | first),
           (node.status.allocatable.cpu),
           (node.status.allocatable.memory)) }}
      {% endfor %}

- name: Uncordon 所有节点（原生模块，幂等）
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Node
    name: "{{ item }}"
    definition:
      spec:
        unschedulable: false
  loop: "{{ nodes_info.resources | map(attribute='metadata.name') | list }}"
  register: uncordon_results

- name: 显示 uncordon 结果
  debug:
    msg: >
      Uncordon {{ item.item }}:
      {{ '成功' if item.changed else '节点已可调度' }}
  loop: "{{ uncordon_results.results }}"

- name: 验证最终节点状态
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: final_nodes_status

- name: 显示最终节点状态
  debug:
    msg: |
      {% for node in final_nodes_status.resources %}
      {{ "%-20s %-10s" | format(
           node.metadata.name,
           node.spec.unschedulable | default(false) | ternary('SchedulingDisabled', 'Ready')) }}
      {% endfor %}