---
- name: Add/Update Seaweedfs Helm repository
  kubernetes.core.helm_repository:
    name: hi168
    repo_url: "{{ seaweedfs_chart_repo }}"
    state: present  


- name: 渲染 SeaweedFS values 文件
  ansible.builtin.template:
    src: values.yaml.j2
    dest: /tmp/seaweedfs-values.yaml
    mode: '0600'

- name: 安装/升级 SeaweedFS 分布式集群
  kubernetes.core.helm:
    name: "seaweedfs"
    chart_ref: "hi168/seaweedfs"
    release_namespace: "{{ seaweedfs_namespace }}"
    create_namespace: true
    values_files:
      - /tmp/seaweedfs-values.yaml
    wait: true
    timeout: 10m  # 增加超时时间

- name: 等待 SeaweedFS S3 端口可达
  wait_for:
    host: "{{ seaweedfs_s3_host | default(groups['kube_node'][0]) }}"
    port: "{{ seaweedfs_s3_node_port }}"
    timeout: 300
  delegate_to: localhost

- name: 自动创建 JuiceFS 用桶 juicefs-s3-public
  command: |
    kubectl run s3-mb --rm -i --restart=Never --image=minio/mc -- \
      mc alias add local http://{{ seaweedfs_s3_host }}:{{ seaweedfs_s3_node_port }} {{ seaweedfs_root_user }} {{ seaweedfs_root_password }} && \
      mc mb --ignore-existing local/juicefs-s3-public
  delegate_to: localhost
  register: mb_out
  failed_when: '"Created" not in mb_out.stdout'