---
- name: 添加 Quantanexus Helm 仓库
  shell: |
    helm repo list | grep -q "hi168" || helm repo add hi168 https://helm.hi168.com/charts 2>/dev/null
    helm repo update hi168
  changed_when: false

- name: 确保 Quantanexus 配置目录存在
  file:
    path: "{{ quantanexus_work_dir }}"
    state: directory
    mode: '0755'

- name: 创建 values.yaml 配置文件
  template:
    src: values.yaml.j2
    dest: "{{ quantanexus_work_dir }}/values.yaml"

- name: 创建 Quantanexus 命名空间
  shell: |
    /opt/kube/bin/kubectl create namespace quantanexus-mgr 2>/dev/null || true
  changed_when: false

- name: 部署 Quantanexus
  shell: |
    cd {{ quantanexus_work_dir }}
    helm upgrade --install quantanexus-mgr hi168/quantanexus-mgr \
      --namespace quantanexus-mgr \
      --version {{ quantanexus_version }} \
      -f values.yaml

- name: 等待 Quantanexus Pods 就绪
  shell: |
    /opt/kube/bin/kubectl wait --for=condition=Ready pod -l app.kubernetes.io/instance=quantanexus -n quantanexus-mgr --timeout=300s
  changed_when: false