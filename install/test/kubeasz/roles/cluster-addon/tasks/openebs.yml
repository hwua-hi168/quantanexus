- block:
    - name: 清理 snapshot-controller crd
      shell: "echo 'clean existed snapshot-controller crds'; \
            {{ base_dir }}/bin/kubectl delete crd volumesnapshotclasses.snapshot.storage.k8s.io || echo ''; \
            {{ base_dir }}/bin/kubectl delete crd volumesnapshots.snapshot.storage.k8s.io || echo ''; \
            {{ base_dir }}/bin/kubectl delete crd volumesnapshotcontents.snapshot.storage.k8s.io || echo ''"
      ignore_errors: true

    - name: prepare some dirs
      file: name={{ cluster_dir }}/yml/openebs state=directory

    - name: 创建命名空间{{ openebs_namespace }}
      shell: "{{ base_dir }}/bin/kubectl create ns {{ openebs_namespace }} || echo ''"

    - name: 创建chart 个性化设置
      template: src=openebs/{{ item }}.j2 dest={{ cluster_dir }}/yml/openebs/{{ item }}
      with_items:
      - "values.yaml"
      - "sc.yaml"

    - name: helm 部署 openebs operator 
      shell: "{{ base_dir }}/bin/helm upgrade openebs --install -n {{ openebs_namespace }} \
              -f {{ cluster_dir }}/yml/openebs/values.yaml \
              {{ base_dir }}/roles/cluster-addon/files/openebs-{{ openebs_ver }}.tgz"

    - name: 轮询等待部署 openebs 
      shell: "{{ base_dir }}/bin/helm ls -n {{ openebs_namespace }}|grep openebs|awk '{print $8}'"
      register: chart_status
      until: chart_status.stdout == "deployed"
      retries: 15
      delay: 5
      ignore_errors: true

    - name: 轮询等待lvm-localpv-controller 运行
      shell: "{{ base_dir }}/bin/kubectl get pod -n {{ openebs_namespace }}|grep 'lvm-localpv-controller'|awk '{print $2}'"
      register: pod_status
      until: pod_status.stdout == "5/5"
      retries: 15
      delay: 10
      ignore_errors: true

    - name: 创建lvm storageclass
      shell: "{{ base_dir }}/bin/kubectl apply -f {{ cluster_dir }}/yml/openebs/sc.yaml" 

  when: 'openebs_install == "yes"'
