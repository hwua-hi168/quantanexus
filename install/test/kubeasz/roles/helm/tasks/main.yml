- name: Check if helm is already installed
  stat: path="/usr/local/bin/helm"
  register: helm_installed

- name: Show message if helm is already installed
  debug:
    msg: "Helm is already installed, skipping installation"
  when: helm_installed.stat.exists

- block:
    - name: Ensure dependencies are installed (Debian/Ubuntu)
      package:
        name:
          - curl
          - tar
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure dependencies are installed (RedHat/CentOS)
      package:
        name:
          - curl
          - tar
        state: present
      when: ansible_os_family == "RedHat"

    - name: Create temporary directory for helm installation
      tempfile:
        state: directory
        suffix: helm
      register: helm_tempdir

    - name: Download and extract Helm binary
      unarchive:
        src: "https://get.helm.sh/helm-{{ helm_version }}-{{ helm_arch }}.tar.gz"
        dest: "{{ helm_tempdir.path }}"
        remote_src: yes
        creates: "{{ helm_tempdir.path }}/{{ helm_arch }}/helm"

    - name: Move helm binary to install path
      copy:
        src: "{{ helm_tempdir.path }}/{{ helm_arch }}/helm"
        dest: "/usr/local/bin/helm"
        mode: '0755'
        remote_src: yes
      become: yes

    - name: Clean up temporary directory
      file:
        path: "{{ helm_tempdir.path }}"
        state: absent

    - name: Verify Helm installation
      command: helm version
      register: helm_check
      changed_when: false

    - name: Display Helm version
      debug:
        msg: "Helm installed successfully: {{ helm_check.stdout }}"
  when: not helm_installed.stat.exists
  vars:
    helm_version: "v3.19.0"
    helm_arch: >-
      {{
        'linux-arm64' if ansible_architecture == 'aarch64'
        else 'linux-amd64' if ansible_architecture == 'x86_64'
        else ansible_architecture
      }}